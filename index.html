<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Guard Portal</title>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; margin: 0; background: #f4f7f9; }
        .scanner-box { width: 100%; height: 250px; background: #000; position: relative; }
        #video { width: 100%; height: 100%; object-fit: cover; }
        .card { background: #fff; margin: 10px; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; position: relative; }
        label { display: block; font-size: 12px; font-weight: 600; color: #666; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; margin-top: 5px; padding-right: 40px; }
        .mic-btn { position: absolute; right: 10px; top: 32px; font-size: 20px; cursor: pointer; color: #007bff; border:none; background:none; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .btn-scan { background: #007bff; color: white; }
        .btn-submit { background: #28a745; color: white; }
        #status-indicator { text-align: center; padding: 10px; font-weight: 600; background: #e7f3ff; color: #007bff; }
    </style>
</head>
<body onload="initApp()">

<div id="status-indicator">Initializing System...</div>

<div id="mainApp">
    <div class="scanner-box">
        <video id="video" autoplay muted playsinline></video>
    </div>
    
    <div class="card">
        <button class="btn btn-scan" onclick="captureAndIdentify()">ðŸ‘¤ SCAN FACE / QR CODE</button>
        
        <form onsubmit="event.preventDefault(); submitEntry();">
            <div class="form-group">
                <label>Unit/House Number</label>
                <input type="text" id="house" placeholder="Search Unit..." list="unitList" required>
                <datalist id="unitList">
                    <option value="Office">
                    <script>for(let i=1;i<=204;i++) document.write(`<option value="Unit ${i}">`);</script>
                </datalist>
                <button type="button" class="mic-btn" onclick="startVoice('house')">ðŸŽ¤</button>
            </div>

            <div class="form-group">
                <label>Mobile Number (Required)</label>
                <input type="tel" id="mobile" placeholder="10 Digits" maxlength="10" oninput="handleMobileSearch(this)" required>
                <button type="button" class="mic-btn" onclick="startVoice('mobile')">ðŸŽ¤</button>
            </div>

            <div class="form-group">
                <label>Visitor Name (Required)</label>
                <input type="text" id="name" placeholder="Full Name" required>
                <button type="button" class="mic-btn" onclick="startVoice('name')">ðŸŽ¤</button>
            </div>

            <div class="form-group">
                <label>Vehicle Photo (Read Plate)</label>
                <input type="file" id="p2File" accept="image/*" capture="camera" onchange="processVehicleOCR(this)">
                <input type="text" id="vehicle" placeholder="Detected Plate Number" style="margin-top:10px;">
                <button type="button" class="mic-btn" style="top:90px" onclick="startVoice('vehicle')">ðŸŽ¤</button>
            </div>

            <div class="form-group">
                <label>Purpose of Visit</label>
                <select id="purpose" onchange="toggleOtherPurpose(this.value)">
                    <option value="Personal">Personal</option>
                    <option value="Delivery">Delivery</option>
                    <option value="Maintenance">Maintenance</option>
                    <option value="Courier">Courier</option>
                    <option value="Other">Other...</option>
                </select>
                <input type="text" id="otherPurpose" placeholder="Type purpose here" style="display:none; margin-top:5px;">
            </div>

            <div class="form-group">
                <label>Number of Visitors</label>
                <input type="number" id="vCount" value="1" min="1">
                <button type="button" class="mic-btn" onclick="startVoice('vCount')">ðŸŽ¤</button>
            </div>

            <button type="submit" id="submitBtn" class="btn btn-submit">SUBMIT & SEND WHATSAPP</button>
        </form>
    </div>
</div>

<script>
const URL = "https://script.google.com/macros/s/AKfycbz4fx6vtiwjOfCXlKfiy_VJJ9XfBItEzdW8_qNLjyiZ3JCJvAi_W9rLDSkBIUv8Cvtb/exec"; 
let localProfiles = [];
let lastFaceDescriptor = null;

// Initialize System
async function initApp() {
    const status = document.getElementById('status-indicator');
    try {
        const MODEL_URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights';
        await faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL);
        await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
        await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
        
        const res = await fetch(URL + "?action=getProfiles");
        const data = await res.json();
        localProfiles = data.profiles;
        
        startCamera();
        status.innerText = "âœ“ System Ready: Scan Face or QR";
    } catch (e) {
        status.innerText = "âŒ Initialization Error";
    }
}

// ðŸŽ¤ VOICE TO TEXT (MIC)
function startVoice(fieldId) {
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'en-IN';
    recognition.start();
    document.getElementById('status-indicator').innerText = "Listening...";
    
    recognition.onresult = (event) => {
        let text = event.results[0][0].transcript;
        document.getElementById(fieldId).value = text.replace(/\s/g, '').toUpperCase();
        document.getElementById('status-indicator').innerText = "âœ“ Voice Captured";
    };
}

// ðŸš— VEHICLE OCR FIX
async function processVehicleOCR(input) {
    if (!input.files[0]) return;
    document.getElementById('status-indicator').innerText = "Reading Number Plate... Please wait.";
    
    const base64 = await toBase64(input.files[0]);
    const res = await fetch(URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'ocr', image: base64.split(',')[1] })
    });
    const data = await res.json();
    document.getElementById('vehicle').value = data.text;
    document.getElementById('status-indicator').innerText = "âœ“ Plate Read Successfully";
}

// ðŸ‘¤ FACE SCAN
async function captureAndIdentify() {
    const video = document.getElementById('video');
    const status = document.getElementById('status-indicator');
    status.innerText = "Scanning Face/QR...";
    
    const detection = await faceapi.detectSingleFace(video).withFaceLandmarks().withFaceDescriptor();
    if (detection) {
        lastFaceDescriptor = Array.from(detection.descriptor);
        let match = { dist: 1, name: '', mob: '' };
        
        localProfiles.forEach(p => {
            const dist = faceapi.euclideanDistance(lastFaceDescriptor, new Float32Array(JSON.parse(p[2])));
            if(dist < match.dist) match = { dist, name: p[0], mob: p[1] };
        });

        if (match.dist < 0.5) {
            document.getElementById('name').value = match.name;
            document.getElementById('mobile').value = match.mob;
            status.innerText = "âœ“ Welcome back, " + match.name;
        } else {
            status.innerText = "New Visitor Detected";
        }
    }
}

// ðŸ” MOBILE AUTO-SEARCH
async function handleMobileSearch(el) {
    if (el.value.length === 10) {
        const res = await fetch(URL + "?action=search&mobile=" + el.value);
        const data = await res.json();
        if (data.found) {
            document.getElementById('name').value = data.name;
            document.getElementById('status-indicator').innerText = "âœ“ Mobile Found: " + data.name;
        }
    }
}

function toggleOtherPurpose(val) {
    document.getElementById('otherPurpose').style.display = (val === 'Other') ? 'block' : 'none';
}

function toBase64(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
    });
}

function startCamera() {
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(s => {
        document.getElementById('video').srcObject = s;
    });
}
</script>
</body>
</html>
